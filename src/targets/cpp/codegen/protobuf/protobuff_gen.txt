

@@BEGIN-TEMPLATE NAME="MAIN" TYPE="ROOT"
@@OPEN-OUTPUT-FILE FILENAME="output.h"
  @@INCLUDE TEMPLATE="V1"
@@CLOSE-OUTPUT-FILE
@@END-TEMPLATE NAME="MAIN"


@@BEGIN-TEMPLATE NAME="V1" TYPE="ROOT"
#include <protobuf/baselib.h>

// structures

  @@INCLUDE TEMPLATE="MAP_3"
  
// serialization

  @@INCLUDE TEMPLATE="ROOT_3"
  
// deserialization

  @@INCLUDE TEMPLATE="ROOT_4"
  
// printing

  @@INCLUDE TEMPLATE="ROOT_5"
@@END-TEMPLATE NAME="V1"


@@BEGIN-TEMPLATE NAME="MAP_3" TYPE="ROOT"
  @@FOR-EACH-OF PUBLISHABLE-STRUCTS() TYPE="STRUCT" TEMPLATE="MAP-S-CALLING"
@@END-TEMPLATE NAME="MAP_3"


@@BEGIN-TEMPLATE NAME="ROOT_3" TYPE="ROOT"
  @@FOR-EACH-OF PUBLISHABLE-STRUCTS() TYPE="STRUCT" TEMPLATE="SERIALIZE-S-CALLING-ALT"
@@END-TEMPLATE NAME="ROOT_3"


@@BEGIN-TEMPLATE NAME="ROOT_4" TYPE="ROOT"
  @@FOR-EACH-OF PUBLISHABLE-STRUCTS() TYPE="STRUCT" TEMPLATE="DESERIALIZE-S-CALLING-ALT"
@@END-TEMPLATE NAME="ROOT_4"


@@BEGIN-TEMPLATE NAME="ROOT_5" TYPE="ROOT"
  @@FOR-EACH-OF PUBLISHABLE-STRUCTS() TYPE="STRUCT" TEMPLATE="PRINT-S"
@@END-TEMPLATE NAME="ROOT_5"


@@BEGIN-TEMPLATE NAME="SERIALIZE-S-CALLING-ALT" TYPE="STRUCT"
inline void serialize@STRUCT-NAME@( @STRUCT-NAME@& s, OStream& o ) {
   @@LET LOCAL-MEMCTR=1
   @@FOR-EACH-OF MEMBERS() BEGIN
      @@INCLUDE TEMPLATE="SERIALIZE-S-FOR-EACH-OF-MEMBERS" PARAM-NAME="s.@MEMBER-NAME@" PARAM-TYPE="@MEMBER-TYPE@" PARAM-MEMCTR=LOCAL-MEMCTR
   @@LET LOCAL-MEMCTR=1+LOCAL-MEMCTR
   @@FOR-EACH-OF END
}

@@END-TEMPLATE NAME="SERIALIZE-S-CALLING-ALT"


@@BEGIN-TEMPLATE NAME="SERIALIZE-S-FOR-EACH-OF-MEMBERS" TYPE="STRUCT-MEMBER"
@@INCLUDE-WITH MEMBER-TYPE() TEMPLATE="SERIALIZE-TYPE" TYPE="DATATYPE" PARAM-NAME="@PARAM-NAME@" PARAM-MEMCTR=PARAM-MEMCTR
@@END-TEMPLATE NAME="SERIALIZE-S-FOR-EACH-OF-MEMBERS"


@@BEGIN-TEMPLATE NAME="SERIALIZE-TYPE" TYPE="DATATYPE"
@@IF IS-INTEGER()
   o.writeInt(@PARAM-MEMCTR@, @PARAM-NAME@);
@@ELIF IS-FIXED-POINT()
   o.writeDouble(@PARAM-MEMCTR@, @PARAM-NAME@);
@@ELIF IS-FLOATING-POINT()
   o.writeDouble(@PARAM-MEMCTR@, @PARAM-NAME@);
@@ELIF IS-CHARACTER-STRING()
   o.writeString(@PARAM-MEMCTR@, @PARAM-NAME@);
@@ELIF IS-STRUCTURE()
   serialize@MEMBER-TYPE@(@PARAM-MEMCTR@, @PARAM-NAME@, o);
@@ELIF IS-ENUM()
   o.writeInt(@PARAM-MEMCTR@, @PARAM-NAME@);
@@ELIF IS-SEQUENCE()
   for(auto item:@PARAM-NAME@) {
@@INCLUDE-WITH COLLECTION-TYPE() TEMPLATE="SERIALIZE-TYPE" PARAM-NAME="item" TYPE="DATATYPE" PARAM-MEMCTR=PARAM-MEMCTR
   }
@@ELIF IS-DICTIONARY()
   for(auto item:@PARAM-NAME@) {
@@INCLUDE-WITH COLLECTION-TYPE2() TEMPLATE="SERIALIZE-TYPE" PARAM-NAME="item.first" TYPE="DATATYPE" PARAM-MEMCTR=PARAM-MEMCTR
@@INCLUDE-WITH COLLECTION-TYPE() TEMPLATE="SERIALIZE-TYPE" PARAM-NAME="item.second" TYPE="DATATYPE" PARAM-MEMCTR=PARAM-MEMCTR
   }
@@ELSE
@@ASSERT "0" MSG="Cannot process member for serialization: name=@PARAM-NAME@, type=@MEMBER-TYPE@"
@@ENDIF
@@END-TEMPLATE NAME="SERIALIZE-TYPE"






@@BEGIN-TEMPLATE NAME="DESERIALIZE-S-CALLING-ALT" TYPE="STRUCT"
inline bool deserialize@STRUCT-NAME@( @STRUCT-NAME@& s, IStream& i ) {
   int type;
   int fieldNumber;
   bool readret;
   @@LET LOCAL-MEMCTR=0
   @@FOR-EACH-OF MEMBERS() BEGIN
      @@LET LOCAL-MEMCTR=1+LOCAL-MEMCTR
   @@FOR-EACH-OF END
   const int memcnt = @LOCAL-MEMCTR@;
   uint8_t initFlags[memcnt];
   memset( initFlags, 0, memcnt );
   do
   {
      readret = i.readFieldTypeAndID( type, fieldNumber );
	  if ( !readret )
		  break;
	  switch ( fieldNumber )
	  {
   @@LET LOCAL-MEMCTR=0
   @@FOR-EACH-OF MEMBERS() BEGIN
      @@INCLUDE TEMPLATE="DESERIALIZE-S-FOR-EACH-OF-MEMBERS" PARAM-NAME="@MEMBER-NAME@" PARAM-TYPE="@MEMBER-TYPE@" PARAM-MEMCTR=LOCAL-MEMCTR
   @@LET LOCAL-MEMCTR=1+LOCAL-MEMCTR
   @@FOR-EACH-OF END
		default:
		{
			// TODO: what?
			break;
		}
	  }
   }
   while ( 1 ); // TODO: stop criterion (except the end of the message?

   bool OK = true;
   for ( int i=0; i<memcnt; i++ )
	   OK = OK && initFlags[i] != 0;

   return OK;
}

@@END-TEMPLATE NAME="DESERIALIZE-S-CALLING-ALT"


@@BEGIN-TEMPLATE NAME="DESERIALIZE-S-FOR-EACH-OF-MEMBERS" TYPE="STRUCT-MEMBER"
@@INCLUDE-WITH MEMBER-TYPE() TEMPLATE="DESERIALIZE-TYPE" TYPE="DATATYPE" PARAM-NAME="@PARAM-NAME@" PARAM-MEMCTR=PARAM-MEMCTR
@@END-TEMPLATE NAME="DESERIALIZE-S-FOR-EACH-OF-MEMBERS"


@@BEGIN-TEMPLATE NAME="DESERIALIZE-TYPE" TYPE="DATATYPE"
@@LET LOCAL-TMP1=PARAM-MEMCTR+1
		case @LOCAL-TMP1@:
		{
@@IF IS-INTEGER()
			if ( type == VARINT )
			{
				i.readVariantInt64( s.@PARAM-NAME@ );
				initFlags[@PARAM-MEMCTR@] = 1;
			}
@@ELIF IS-FIXED-POINT()
   @@ASSERT "0" MSG="Cannot process member for deserialization: name=@PARAM-NAME@, type=@MEMBER-TYPE@"
@@ELIF IS-FLOATING-POINT()
   @@ASSERT "0" MSG="Cannot process member for deserialization: name=@PARAM-NAME@, type=@MEMBER-TYPE@"
@@ELIF IS-CHARACTER-STRING()
			if ( type == LENGTH_DELIMITED )
			{
				i.readString( s.@PARAM-NAME@ );
				initFlags[@PARAM-MEMCTR@] = 1;
			}
@@ELIF IS-STRUCTURE()
//   deserialize@MEMBER-TYPE@(@PARAM-NAME@, i);
   @@ASSERT "0" MSG="Cannot process member for deserialization: name=@PARAM-NAME@, type=@MEMBER-TYPE@"
@@ELIF IS-ENUM()
			if ( type == VARINT )
			{
				i.readVariantInt64( s.@PARAM-NAME@ );
				initFlags[@PARAM-MEMCTR@] = 1;
			}
@@ELIF IS-SEQUENCE()
   for(auto item:@PARAM-NAME@) {
@@INCLUDE-WITH COLLECTION-TYPE() TEMPLATE="DESERIALIZE-TYPE" PARAM-NAME="item" TYPE="DATATYPE" PARAM-MEMCTR=PARAM-MEMCTR
   }
@@ELIF IS-DICTIONARY()
   for(auto item:@PARAM-NAME@) {
@@INCLUDE-WITH COLLECTION-TYPE2() TEMPLATE="DESERIALIZE-TYPE" PARAM-NAME="item.first" TYPE="DATATYPE" PARAM-MEMCTR=PARAM-MEMCTR
@@INCLUDE-WITH COLLECTION-TYPE() TEMPLATE="DESERIALIZE-TYPE" PARAM-NAME="item.second" TYPE="DATATYPE" PARAM-MEMCTR=PARAM-MEMCTR
   }
@@ELSE
@@ASSERT "0" MSG="Cannot process member for deserialization: name=@PARAM-NAME@, type=@MEMBER-TYPE@"
@@ENDIF
			break;
		}
@@END-TEMPLATE NAME="DESERIALIZE-TYPE"







@@BEGIN-TEMPLATE NAME="PRINT-S" TYPE="STRUCT"
inline void print@STRUCT-NAME@( @STRUCT-NAME@& s ) {
   @@LET LOCAL-MEMCTR=1
   @@FOR-EACH-OF MEMBERS() BEGIN
    cout << "@MEMBER-NAME@: " << 
      @@INCLUDE TEMPLATE="PRINT-S-FOR-EACH-OF-MEMBERS" PARAM-NAME="@MEMBER-NAME@" PARAM-TYPE="@MEMBER-TYPE@"
     << endl; // @LOCAL-MEMCTR@
   @@LET LOCAL-MEMCTR=1+LOCAL-MEMCTR
   @@FOR-EACH-OF END
}

@@END-TEMPLATE NAME="PRINT-S"


@@BEGIN-TEMPLATE NAME="PRINT-S-FOR-EACH-OF-MEMBERS" TYPE="STRUCT-MEMBER"
@@INCLUDE-WITH MEMBER-TYPE() TEMPLATE="PRINT-TYPE" TYPE="DATATYPE" PARAM-NAME="@PARAM-NAME@"
@@END-TEMPLATE NAME="PRINT-S-FOR-EACH-OF-MEMBERS"


@@BEGIN-TEMPLATE NAME="PRINT-TYPE" TYPE="DATATYPE"
@@IF IS-INTEGER()
   s.@PARAM-NAME@ 
@@ELIF IS-FIXED-POINT()
   s.@PARAM-NAME@ 
@@ELIF IS-FLOATING-POINT()
   s.@PARAM-NAME@ 
@@ELIF IS-CHARACTER-STRING()
   s.@PARAM-NAME@ 
@@ELIF IS-STRUCTURE()
@@ASSERT "0" MSG="Cannot process member for serialization: name=@PARAM-NAME@"
@@ELIF IS-ENUM()
   s.@PARAM-NAME@ 
@@ELIF IS-SEQUENCE()
   for(auto item:@PARAM-NAME@) {
@@ASSERT "0" MSG="Cannot process member for serialization: name=@PARAM-NAME@"
   }
@@ELIF IS-DICTIONARY()
   for(auto item:@PARAM-NAME@) {
@@ASSERT "0" MSG="Cannot process member for serialization: name=@PARAM-NAME@"
   }
@@ELSE
@@ASSERT "0" MSG="Cannot process member for serialization: name=@PARAM-NAME@"
@@ENDIF
@@END-TEMPLATE NAME="PRINT-TYPE"






@@BEGIN-TEMPLATE NAME="MAP-S-CALLING" TYPE="STRUCT"
typedef struct _@STRUCT-NAME@ {
@@LET LOCAL-MEMCTR=1
@@FOR-EACH-OF MEMBERS() BEGIN
   @@INCLUDE-WITH MEMBER-TYPE() TEMPLATE="MAP-TYPE" TYPE="DATATYPE"
   @MEMBER-NAME@; // @LOCAL-MEMCTR@
   @@LET LOCAL-MEMCTR=1+LOCAL-MEMCTR
@@FOR-EACH-OF END
} @STRUCT-NAME@;

@@END-TEMPLATE NAME="MAP-S-CALLING"


@@BEGIN-TEMPLATE NAME="MAP-TYPE" TYPE="DATATYPE"
@@IF IS-INTEGER()
@@IF IS-UNSIGNED-INTEGER()
  @@IF IS-UNSIGNED-INTEGER-FITTING-UINT(8)
   uint8_t 
  @@ELIF IS-UNSIGNED-INTEGER-FITTING-UINT(16)
   uint16_t
  @@ELIF IS-UNSIGNED-INTEGER-FITTING-UINT(32)
   uint32_t
  @@ELIF IS-UNSIGNED-INTEGER-FITTING-UINT(64)
   uint64_t
  @@ELSE
    @@ASSERT "0" MSG="Cannot process member for declaring: type=@MEMBER-TYPE@"
  @@ENDIF
@@ELSE
  @@IF IS-SIGNED-INTEGER-FITTING-INT(8)
   int8_t 
  @@ELIF IS-SIGNED-INTEGER-FITTING-INT(16)
   int16_t
  @@ELIF IS-SIGNED-INTEGER-FITTING-INT(32)
   int32_t
  @@ELIF IS-SIGNED-INTEGER-FITTING-INT(64)
   int64_t
  @@ELSE
    @@ASSERT "0" MSG="Cannot process member for declaring: type=@MEMBER-TYPE@"
  @@ENDIF
@@ENDIF
@@ELIF IS-FIXED-POINT()
   double 
@@ELIF IS-FLOATING-POINT()
  @@IF IS-FLOATING-POINT-FITTING-FLOAT(23,9)
   float 
  @@ELIF IS-FLOATING-POINT-FITTING-FLOAT(53,11)
   double 
  @@ELIF IS-FLOATING-POINT-FITTING-FLOAT(64,16)
   long double 
  @@ELSE
    @@ASSERT "0" MSG="Cannot process member for declaring: type=@MEMBER-TYPE@"
  @@ENDIF
@@ELIF IS-CHARACTER-STRING()
   std::string 
@@ELIF IS-STRUCTURE()
   @MEMBER-TYPE@ 
@@ELIF IS-SEQUENCE()
   vector<
@@INCLUDE-WITH COLLECTION-TYPE() TEMPLATE="MAP-TYPE"
   >
@@ELIF IS-DICTIONARY()
   map<
@@INCLUDE-WITH COLLECTION-TYPE2() TEMPLATE="MAP-TYPE"
   ,
@@INCLUDE-WITH COLLECTION-TYPE() TEMPLATE="MAP-TYPE"
   >
@@ELIF IS-ENUM()
enum @MEMBER-TYPE@ {
   @@FOR-EACH-OF ENUM-VALUES() BEGIN
      @@INCLUDE TEMPLATE="MAP-ENUM-VALUE-ALT"
   @@FOR-EACH-OF END
} 
@@ELSE
   @@ASSERT "0" MSG="Cannot process member for declaring: type=@MEMBER-TYPE@"
@@ENDIF
@@END-TEMPLATE NAME="MAP-TYPE"


@@BEGIN-TEMPLATE NAME="MAP-ENUM-VALUE" TYPE="ENUMVALUE"
@ENUM-VALUE-NAME@=@ENUM-VALUE-VALUE@,
@@END-TEMPLATE NAME="MAP-ENUM-VALUE"


@@BEGIN-TEMPLATE NAME="MAP-ENUM-VALUE-ALT" TYPE="ENUMVALUE"
@@LET LOCAL-NAME="@ENUM-VALUE-NAME@"
@LOCAL-NAME@=@ENUM-VALUE-VALUE@, 
@@END-TEMPLATE NAME="MAP-ENUM-VALUE-ALT"







